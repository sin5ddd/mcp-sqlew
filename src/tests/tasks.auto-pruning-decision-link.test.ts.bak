/**
 * Integration tests for Decision Linking to Pruned Files (v3.5.0 Auto-Pruning)
 * Tests the workflow of linking decisions to pruned files for WHY reasoning (project archaeology)
 */

import { describe, it, beforeEach } from 'node:test';
import assert from 'node:assert/strict';
import Database from 'better-sqlite3';
import { initializeSchema } from '../schema.js';
import { getOrCreateAgent } from '../database.js';
import { setDecision } from '../tools/context.js';
import { getPrunedFiles, linkPrunedFile } from '../tools/tasks.js';
import type { Database as DatabaseType } from '../types.js';

/**
 * Test database instance
 */
let testDb: DatabaseType;

/**
 * Create an in-memory test database
 */
function createTestDatabase(): DatabaseType {
  const db = new Database(':memory:');
  db.pragma('foreign_keys = ON');
  initializeSchema(db);
  return db;
}

/**
 * Helper: Create a test task
 */
function createTestTask(db: DatabaseType, title: string): number {
  const agentId = getOrCreateAgent(db, 'test-agent');
  const statusId = 2; // in_progress

  const result = db.prepare(`
    INSERT INTO t_tasks (title, status_id, priority, created_by_agent_id, assigned_agent_id)
    VALUES (?, ?, 2, ?, ?)
  `).run(title, statusId, agentId, agentId);

  return result.lastInsertRowid as number;
}

/**
 * Helper: Create a pruned file record
 */
function createPrunedFileRecord(db: DatabaseType, taskId: number, filePath: string): number {
  const result = db.prepare(`
    INSERT INTO t_task_pruned_files (task_id, file_path, pruned_ts)
    VALUES (?, ?, unixepoch())
  `).run(taskId, filePath);

  return result.lastInsertRowid as number;
}

describe('Auto-pruning: Decision linking workflow', () => {
  beforeEach(() => {
    testDb = createTestDatabase();
  });

  it('should link decisions to pruned files for WHY reasoning', () => {
    // 1. Setup: Create task with pruned file
    const taskId = createTestTask(testDb, 'Implement OAuth authentication');
    const prunedFileId = createPrunedFileRecord(testDb, taskId, 'src/auth/oauth-handler.ts');

    // 2. Create decision explaining why file wasn't created
    const decisionResult = setDecision({
      key: 'oauth-not-implemented',
      value: 'Decided to use API key auth instead of OAuth',
      rationale: 'OAuth adds significant complexity for minimal benefit in our use case. API key auth is simpler and sufficient for our current needs.',
      tags: ['architecture', 'authentication'],
      status: 'active'
    });

    assert.ok(decisionResult.success, 'Decision creation should succeed');
    assert.strictEqual(decisionResult.key, 'oauth-not-implemented');

    // 3. Link decision to pruned file
    const linkResult = linkPrunedFile({
      pruned_file_id: prunedFileId,
      decision_key: 'oauth-not-implemented'
    });

    assert.ok(linkResult.success, 'Decision linking should succeed');
    assert.strictEqual(linkResult.pruned_file_id, prunedFileId);
    assert.strictEqual(linkResult.decision_key, 'oauth-not-implemented');
    assert.strictEqual(linkResult.task_id, taskId);
    assert.strictEqual(linkResult.file_path, 'src/auth/oauth-handler.ts');

    // 4. Verify link in database directly
    const linkedDecisionId = testDb.prepare(`
      SELECT linked_decision_id FROM t_task_pruned_files WHERE id = ?
    `).get(prunedFileId) as { linked_decision_id: number | null } | undefined;

    assert.ok(linkedDecisionId, 'Pruned file record should exist');
    assert.ok(linkedDecisionId.linked_decision_id !== null, 'Decision ID should be linked');

    // 5. Query pruned files - decision key should be returned
    const getPrunedResult = getPrunedFiles({
      task_id: taskId,
      limit: 100
    });

    assert.ok(getPrunedResult.success, 'get_pruned_files should succeed');
    assert.strictEqual(getPrunedResult.task_id, taskId);
    assert.strictEqual(getPrunedResult.count, 1, 'Should return 1 pruned file');
    assert.strictEqual(getPrunedResult.pruned_files.length, 1, 'pruned_files array should have 1 item');

    const prunedFile = getPrunedResult.pruned_files[0];
    assert.strictEqual(prunedFile.id, prunedFileId, 'Pruned file ID should match');
    assert.strictEqual(prunedFile.file_path, 'src/auth/oauth-handler.ts', 'File path should match');
    assert.ok(prunedFile.pruned_at, 'Should have pruned_at timestamp');
    assert.ok(prunedFile.linked_decision, 'Should have linked_decision key');
    assert.strictEqual(prunedFile.linked_decision, 'oauth-not-implemented', 'Linked decision key should match');
  });

  it('should handle multiple pruned files with different decisions', () => {
    const taskId = createTestTask(testDb, 'Feature implementation');

    // Create pruned files
    const prunedFileId1 = createPrunedFileRecord(testDb, taskId, 'src/oauth-handler.ts');
    const prunedFileId2 = createPrunedFileRecord(testDb, taskId, 'src/ldap-connector.ts');

    // Create decisions
    setDecision({
      key: 'no-oauth',
      value: 'OAuth not needed for MVP',
      status: 'active'
    });

    setDecision({
      key: 'no-ldap',
      value: 'LDAP integration deferred to Phase 2',
      status: 'active'
    });

    // Link decisions
    linkPrunedFile({
      pruned_file_id: prunedFileId1,
      decision_key: 'no-oauth'
    });

    linkPrunedFile({
      pruned_file_id: prunedFileId2,
      decision_key: 'no-ldap'
    });

    // Verify
    const getPrunedResult = getPrunedFiles({
      task_id: taskId
    });

    assert.strictEqual(getPrunedResult.count, 2, 'Should have 2 pruned files');

    const file1 = getPrunedResult.pruned_files.find(f => f.file_path === 'src/oauth-handler.ts');
    const file2 = getPrunedResult.pruned_files.find(f => f.file_path === 'src/ldap-connector.ts');

    assert.ok(file1, 'Should find oauth-handler.ts');
    assert.ok(file2, 'Should find ldap-connector.ts');
    assert.strictEqual(file1?.linked_decision, 'no-oauth');
    assert.strictEqual(file2?.linked_decision, 'no-ldap');
  });

  it('should handle pruned files without linked decisions', () => {
    const taskId = createTestTask(testDb, 'Task with unlinked pruned files');
    createPrunedFileRecord(testDb, taskId, 'src/temp-file.ts');

    const getPrunedResult = getPrunedFiles({
      task_id: taskId
    });

    assert.ok(getPrunedResult.success);
    assert.strictEqual(getPrunedResult.count, 1);

    const prunedFile = getPrunedResult.pruned_files[0];
    assert.strictEqual(prunedFile.linked_decision, null, 'Unlinked file should have null decision');
  });

  it('should handle linking to non-existent decision gracefully', () => {
    const taskId = createTestTask(testDb, 'Task for error test');
    const prunedFileId = createPrunedFileRecord(testDb, taskId, 'src/test.ts');

    // Attempt to link non-existent decision
    assert.throws(
      () => {
        linkPrunedFile({
          pruned_file_id: prunedFileId,
          decision_key: 'does-not-exist'
        });
      },
      /Decision not found: does-not-exist/,
      'Should throw error for non-existent decision'
    );
  });

  it('should handle linking to non-existent pruned file gracefully', () => {
    // Create decision
    setDecision({
      key: 'test-decision',
      value: 'Test decision value',
      status: 'active'
    });

    // Attempt to link non-existent pruned file
    assert.throws(
      () => {
        linkPrunedFile({
          pruned_file_id: 99999,
          decision_key: 'test-decision'
        });
      },
      /Pruned file record not found: 99999/,
      'Should throw error for non-existent pruned file'
    );
  });

  it('should validate required parameters for linkPrunedFile', () => {
    // Missing pruned_file_id
    assert.throws(
      () => {
        linkPrunedFile({
          pruned_file_id: 0,
          decision_key: 'test'
        });
      },
      /pruned_file_id is required and must be a number/,
      'Should throw for invalid pruned_file_id'
    );

    // Missing decision_key
    assert.throws(
      () => {
        linkPrunedFile({
          pruned_file_id: 1,
          decision_key: ''
        });
      },
      /decision_key is required and must be a string/,
      'Should throw for empty decision_key'
    );
  });

  it('should validate required parameters for getPrunedFiles', () => {
    // Missing task_id
    assert.throws(
      () => {
        getPrunedFiles({
          task_id: 0
        });
      },
      /task_id is required and must be a number/,
      'Should throw for invalid task_id'
    );

    // Non-existent task
    assert.throws(
      () => {
        getPrunedFiles({
          task_id: 99999
        });
      },
      /Task not found: 99999/,
      'Should throw for non-existent task'
    );
  });

  it('should allow updating linked decision for a pruned file', () => {
    const taskId = createTestTask(testDb, 'Task for update test');
    const prunedFileId = createPrunedFileRecord(testDb, taskId, 'src/feature.ts');

    // Create two decisions
    setDecision({
      key: 'decision-v1',
      value: 'Initial decision',
      status: 'active'
    });

    setDecision({
      key: 'decision-v2',
      value: 'Updated decision',
      status: 'active'
    });

    // Link first decision
    linkPrunedFile({
      pruned_file_id: prunedFileId,
      decision_key: 'decision-v1'
    });

    // Verify first link
    let getPrunedResult = getPrunedFiles({ task_id: taskId });
    assert.strictEqual(getPrunedResult.pruned_files[0].linked_decision, 'decision-v1');

    // Update to second decision
    linkPrunedFile({
      pruned_file_id: prunedFileId,
      decision_key: 'decision-v2'
    });

    // Verify updated link
    getPrunedResult = getPrunedFiles({ task_id: taskId });
    assert.strictEqual(getPrunedResult.pruned_files[0].linked_decision, 'decision-v2');
  });

  it('should respect limit parameter in getPrunedFiles', () => {
    const taskId = createTestTask(testDb, 'Task with many pruned files');

    // Create 5 pruned files
    for (let i = 1; i <= 5; i++) {
      createPrunedFileRecord(testDb, taskId, `src/file${i}.ts`);
    }

    // Query with limit
    const getPrunedResult = getPrunedFiles({
      task_id: taskId,
      limit: 3
    });

    assert.ok(getPrunedResult.success);
    assert.strictEqual(getPrunedResult.count, 3, 'Should respect limit parameter');
    assert.strictEqual(getPrunedResult.pruned_files.length, 3);
  });

  console.log('\nâœ… All decision linking to pruned files tests passed!\n');
});
