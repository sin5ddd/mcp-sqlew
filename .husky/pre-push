#!/usr/bin/env sh
echo "ğŸ” Running pre-push checks..."

echo "ğŸ§ª Running comprehensive feature tests..."
npm run test:all-features || {
  echo "âŒ Feature tests failed! Please fix failing tests before pushing."
  exit 1
}

# Check if migration files changed since remote branch
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "origin/main")
if git diff --name-only HEAD "$REMOTE_BRANCH" 2>/dev/null | grep -q "src/config/knex/"; then
  echo "ğŸ—„ï¸  Migration files detected, running migration tests..."

  npm run test:migrations || {
    echo "âŒ Migration safety tests failed! Please fix migration issues before pushing."
    exit 1
  }

  npm run test:migrations:ci || {
    echo "âŒ Historical migration tests failed! Please fix backward compatibility before pushing."
    exit 1
  }
else
  echo "âœ… No migration files changed, skipping migration tests"
fi

echo "âœ… All pre-push checks passed!"
