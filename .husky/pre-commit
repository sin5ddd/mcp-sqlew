#!/usr/bin/env sh
echo "ğŸ” Running strict pre-commit checks..."

# ============================================================================
# STEP 1: Build Check
# ============================================================================
echo "ğŸ“¦ Building TypeScript..."
npm run build || {
  echo "âŒ Build failed! Please fix compilation errors before committing."
  exit 1
}

# ============================================================================
# STEP 2: Test Suite (excludes VCS tests that perform git commits)
# ============================================================================
echo "ğŸ§ª Running test suite (this may take 2-5 minutes)..."
echo "ğŸ’¡ VCS tests excluded (they perform actual git commits)"
echo "ğŸ’¡ Docker-dependent tests excluded (requires manual execution)"
npm test || {
  echo "âŒ Tests failed! Please fix all test failures before committing."
  echo "ğŸ’¡ Tip: Run 'npm test' locally to see detailed errors"
  echo "ğŸ’¡ To run VCS tests: npm run test:vcs"
  echo "ğŸ’¡ To run ALL tests: npm run test:all"
  exit 1
}

# ============================================================================
# STEP 3: Migration Integrity Verification
# ============================================================================
echo "ğŸ”’ Verifying migration file integrity..."

# Check if any migration files were modified
MODIFIED_MIGRATIONS=$(git diff --cached --name-only | grep "src/config/knex/\(bootstrap\|upgrades\|enhancements\)/" | grep "\.ts$" || true)

if [ -n "$MODIFIED_MIGRATIONS" ]; then
  # Detect remote tracking branch (try origin/main, origin/master, origin/dev)
  REMOTE_BRANCH=""
  if git rev-parse --verify origin/main >/dev/null 2>&1; then
    REMOTE_BRANCH="origin/main"
  elif git rev-parse --verify origin/master >/dev/null 2>&1; then
    REMOTE_BRANCH="origin/master"
  elif git rev-parse --verify origin/dev >/dev/null 2>&1; then
    REMOTE_BRANCH="origin/dev"
  fi

  if [ -z "$REMOTE_BRANCH" ]; then
    echo "âš ï¸  No remote tracking branch found (origin/main, origin/master, or origin/dev)"
    echo "ğŸ’¡ Skipping migration integrity check (local-only repository)"
  else
    # Check if these files exist in remote branch (pushed files)
    for file in $MODIFIED_MIGRATIONS; do
      # Check if file exists in the remote branch
      if git cat-file -e "$REMOTE_BRANCH":"$file" 2>/dev/null; then
        echo "âŒ CRITICAL: PUSHED migration file was edited: $file"
        echo ""
        echo "ğŸ“‹ MIGRATION POLICY:"
        echo "   - NEVER edit PUSHED migration files"
        echo "   - Create a new enhancement migration instead"
        echo "   - See CLAUDE.md for migration best practices"
        echo ""
        echo "ğŸ”§ To fix this:"
        echo "   1. Revert changes to $file"
        echo "   2. Create new migration: npm run migrate:make <name>"
        echo "   3. Implement your changes in the new migration"
        echo ""
        echo "â„¹ï¸  Detected remote: $REMOTE_BRANCH"
        exit 1
      fi
    done

    echo "âœ… New migration files detected (not yet pushed to $REMOTE_BRANCH)"
  fi
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸ’¡ Pre-push will run minimal smoke tests only"
echo "ğŸ’¡ To run Docker tests manually: npm run test:docker"
