#!/usr/bin/env sh
echo "ğŸ” Running pre-commit checks..."

echo "ğŸ“¦ Building TypeScript..."
npm run build || {
  echo "âŒ Build failed\! Please fix errors before committing."
  exit 1
}

# Check if migration files are staged
STAGED_FILES=$(git diff --cached --name-only)
if echo "$STAGED_FILES" | grep -q "src/config/knex/"; then
  echo "ğŸ—„ï¸  Migration files detected, running migration safety tests..."
  npm run test:migrations || {
    echo "âŒ Migration safety tests failed\! Please fix migration issues before committing."
    exit 1
  }

  echo "ğŸ•°ï¸  Running historical migration tests (v3.1+ backward compatibility)..."
  npm run test:migrations:ci || {
    echo "âŒ Historical migration tests failed\! Please fix backward compatibility before committing."
    exit 1
  }
else
  echo "âœ… No migration files changed, skipping migration tests"
fi

echo "âœ… Pre-commit checks passed\!"
